<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∞ Tigrinho Calculator - RagnaTales</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --accent-gold: #ffd700;
            --accent-orange: #ff6b00;
            --accent-green: #00ff88;
            --accent-red: #ff4444;
            --text-primary: #ffffff;
            --text-secondary: #888899;
            --border-color: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at top, #1a1a2e 0%, transparent 50%),
                radial-gradient(ellipse at bottom, #16213e 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, rgba(255,107,0,0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255,107,0,0.3);
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .last-update {
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .update-btn {
            background: linear-gradient(135deg, var(--accent-orange), #ff8c00);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 10px;
            font-family: inherit;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .update-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255,107,0,0.4);
        }

        .update-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .treasures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .treasure-card {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .treasure-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .treasure-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .treasure-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .treasure-verdict {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .verdict-worth {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #003320;
        }

        .verdict-not-worth {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #fff;
        }

        .treasure-body {
            padding: 20px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-box {
            text-align: center;
            flex: 1;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .stat-cost { color: var(--accent-orange); }
        .stat-expected { color: var(--accent-gold); }
        .stat-profit-positive { color: var(--accent-green); }
        .stat-profit-negative { color: var(--accent-red); }

        .drops-list {
            margin-top: 15px;
        }

        .drops-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .drops-toggle:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .drops-content {
            display: none;
            margin-top: 15px;
        }

        .drops-content.show {
            display: block;
        }

        .drop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .drop-item:last-child {
            border-bottom: none;
        }

        .drop-name {
            flex: 1;
        }

        .drop-chance {
            width: 60px;
            text-align: center;
            color: var(--accent-gold);
            font-weight: 600;
        }

        .drop-value {
            width: 120px;
            text-align: right;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .simulator {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-top: 30px;
        }

        .simulator h2 {
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 20px;
            color: var(--accent-gold);
        }

        .sim-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sim-controls select,
        .sim-controls input {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
        }

        .sim-controls input {
            width: 120px;
        }

        .sim-btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
            border: none;
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .sim-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,215,0,0.4);
        }

        .sim-results {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-dark);
            border-radius: 12px;
        }

        .sim-results.show {
            display: block;
        }

        .sim-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .sim-stat {
            text-align: center;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .sim-stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .sim-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sim-items {
            margin-top: 20px;
        }

        .sim-items h3 {
            margin-bottom: 15px;
            color: var(--accent-gold);
        }

        .sim-item-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .formula-box {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
        }

        .formula-box h3 {
            color: var(--accent-gold);
            margin-bottom: 15px;
        }

        .formula-box p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .formula-box code {
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--accent-orange);
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .treasures-grid { grid-template-columns: 1fr; }
            .sim-controls { flex-direction: column; }
            .sim-controls select,
            .sim-controls input { width: 100%; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üé∞ TIGRINHO CALCULATOR</h1>
        <p class="subtitle">Calculadora de Tesouros do RagnaTales</p>
        <div class="last-update">
            <span id="lastUpdate">Carregando...</span>
            <button class="update-btn" id="updateBtn" onclick="updatePrices()">üîÑ Atualizar Pre√ßos</button>
        </div>
    </header>

    <div class="container">
        <div class="formula-box">
            <h3>üìä Como funciona o c√°lculo?</h3>
            <p>
                O <strong>Valor Esperado</strong> √© calculado assim: <code>Œ£(chance √ó pre√ßo √ó quantidade)</code><br><br>
                Por exemplo, se um item de 2B tem 2% de chance: <code>0.02 √ó 2.000.000.000 = 40.000.000z</code> de valor esperado por abertura.<br><br>
                Se o <strong>Valor Esperado &gt; Custo</strong>, estatisticamente <span style="color: var(--accent-green)">VALE A PENA</span>. 
                Caso contr√°rio, <span style="color: var(--accent-red)">N√ÉO VALE</span>.<br><br>
                ‚ö†Ô∏è Lembre-se: isso √© estat√≠stica! Voc√™ pode ter azar ou sorte. A longo prazo, os n√∫meros se equilibram.
            </p>
        </div>

        <div id="treasuresContainer" class="loading">
            Carregando tesouros
        </div>

        <div class="simulator">
            <h2>üé≤ Simulador de Aberturas (Tesouros)</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Simule v√°rias aberturas para ver um resultado poss√≠vel (baseado nas probabilidades reais).
            </p>
            <div class="sim-controls">
                <select id="simTreasure">
                    <option value="escarlate">Tesouro Escarlate</option>
                    <option value="solar">Tesouro Solar</option>
                    <option value="verdejante">Tesouro Verdejante</option>
                    <option value="celeste">Tesouro Celeste</option>
                    <option value="oceanico">Tesouro Oce√¢nico</option>
                    <option value="crepuscular">Tesouro Crepuscular</option>
                </select>
                <input type="number" id="simCount" value="100" min="1" max="10000" placeholder="Qtd">
                <button class="sim-btn" onclick="runSimulation()">üé∞ SIMULAR</button>
            </div>
            <div class="sim-results" id="simResults"></div>
        </div>

        <!-- RUNAS SOMATOL√ìGICAS -->
        <h2 style="font-family: 'Orbitron', sans-serif; color: #8B008B; margin: 50px 0 20px; text-align: center; font-size: 2rem;">
            üß¨ RUNAS SOMATOL√ìGICAS
        </h2>
        
        <div class="formula-box" style="border-color: #8B008B;">
            <h3 style="color: #8B008B;">üìä Como funciona?</h3>
            <p>
                <strong>Custo:</strong> 999 Alma Sombria ‚Üí 1 Condensada ‚Üí 10 Condensadas ‚Üí <strong>1 Runa</strong><br>
                <strong>Total:</strong> <code>9.990 Almas Sombrias</code> por abertura<br><br>
                <strong>Drops:</strong><br>
                ‚Ä¢ 100% - 1x Runa Somatol√≥gica aleat√≥ria (30 tipos diferentes)<br>
                ‚Ä¢ 10% - 1x Caixa de Somatologia (itens raros ~1B)<br>
                ‚Ä¢ 1% - 1x Aura da Mente Corrompida (muito raro)
            </p>
        </div>

        <div id="somatologyContainer" class="loading">
            Carregando runas
        </div>
    </div>

    <script>
        function formatZeny(value) {
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(0) + 'K';
            }
            return value.toLocaleString('pt-BR');
        }

        async function loadTreasures() {
            try {
                const response = await fetch('/api/treasures');
                const data = await response.json();
                
                // Atualiza √∫ltima atualiza√ß√£o
                if (data.lastUpdate) {
                    const date = new Date(data.lastUpdate);
                    document.getElementById('lastUpdate').textContent = 
                        `√öltima atualiza√ß√£o: ${date.toLocaleString('pt-BR')} (${data.priceCount} itens)`;
                }
                
                // Renderiza tesouros
                renderTreasures(data.treasures);
            } catch (error) {
                document.getElementById('treasuresContainer').innerHTML = 
                    `<p style="color: var(--accent-red)">Erro ao carregar: ${error.message}</p>`;
            }
        }

        function renderTreasures(treasures) {
            const container = document.getElementById('treasuresContainer');
            container.className = 'treasures-grid';
            container.innerHTML = '';

            for (const [key, treasure] of Object.entries(treasures)) {
                if (!treasure) continue;

                const profitClass = treasure.profit >= 0 ? 'stat-profit-positive' : 'stat-profit-negative';
                const verdictClass = treasure.isWorthIt ? 'verdict-worth' : 'verdict-not-worth';
                const verdictText = treasure.isWorthIt ? '‚úì VALE' : '‚úó N√ÉO VALE';

                const card = document.createElement('div');
                card.className = 'treasure-card';
                card.innerHTML = `
                    <div class="treasure-header" style="background: linear-gradient(135deg, ${treasure.color}22, transparent)">
                        <span class="treasure-name" style="color: ${treasure.color}">${treasure.treasureName}</span>
                        <span class="treasure-verdict ${verdictClass}">${verdictText}</span>
                    </div>
                    <div class="treasure-body">
                        <div class="stats-row">
                            <div class="stat-box">
                                <div class="stat-label">Custo (${treasure.costAmount} P√≥)</div>
                                <div class="stat-value stat-cost">${formatZeny(treasure.totalCost)}z</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Valor Esperado</div>
                                <div class="stat-value stat-expected">${formatZeny(treasure.expectedValue)}z</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Lucro/Preju√≠zo</div>
                                <div class="stat-value ${profitClass}">
                                    ${treasure.profit >= 0 ? '+' : ''}${formatZeny(treasure.profit)}z
                                    <br><small>(${treasure.profitPercent >= 0 ? '+' : ''}${treasure.profitPercent.toFixed(1)}%)</small>
                                </div>
                            </div>
                        </div>
                        <div class="drops-list">
                            <button class="drops-toggle" onclick="toggleDrops(this)">
                                üìã Ver detalhes dos drops
                            </button>
                            <div class="drops-content">
                                ${treasure.drops.map(drop => `
                                    <div class="drop-item">
                                        <span class="drop-name">${drop.quantity}x ${drop.name}</span>
                                        <span class="drop-chance">${drop.chance}%</span>
                                        <span class="drop-value">${formatZeny(drop.itemPrice)}z</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
        }

        function toggleDrops(btn) {
            const content = btn.nextElementSibling;
            content.classList.toggle('show');
            btn.textContent = content.classList.contains('show') 
                ? 'üìã Esconder detalhes' 
                : 'üìã Ver detalhes dos drops';
        }

        async function updatePrices() {
            const btn = document.getElementById('updateBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Atualizando...';
            
            try {
                await fetch('/api/update-prices', { method: 'POST' });
                await loadTreasures();
                btn.textContent = '‚úÖ Atualizado!';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Atualizar Pre√ßos';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                btn.textContent = '‚ùå Erro';
                btn.disabled = false;
            }
        }

        async function runSimulation() {
            const treasure = document.getElementById('simTreasure').value;
            const count = document.getElementById('simCount').value;
            
            const resultsDiv = document.getElementById('simResults');
            resultsDiv.className = 'sim-results show';
            resultsDiv.innerHTML = '<div class="loading">Simulando</div>';
            
            try {
                const response = await fetch(`/api/simulate/${treasure}/${count}`);
                const data = await response.json();
                
                const profitClass = data.profit >= 0 ? 'stat-profit-positive' : 'stat-profit-negative';
                
                resultsDiv.innerHTML = `
                    <div class="sim-summary">
                        <div class="sim-stat">
                            <div class="sim-stat-label">Custo Total</div>
                            <div class="sim-stat-value stat-cost">${formatZeny(data.totalCost)}z</div>
                        </div>
                        <div class="sim-stat">
                            <div class="sim-stat-label">Valor Obtido</div>
                            <div class="sim-stat-value stat-expected">${formatZeny(data.totalValue)}z</div>
                        </div>
                        <div class="sim-stat">
                            <div class="sim-stat-label">Resultado</div>
                            <div class="sim-stat-value ${profitClass}">
                                ${data.profit >= 0 ? '+' : ''}${formatZeny(data.profit)}z
                            </div>
                        </div>
                        <div class="sim-stat">
                            <div class="sim-stat-label">Retorno</div>
                            <div class="sim-stat-value ${profitClass}">
                                ${data.profitPercent >= 0 ? '+' : ''}${data.profitPercent.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    <div class="sim-items">
                        <h3>üéÅ Itens obtidos (${data.openings} aberturas):</h3>
                        ${Object.entries(data.itemsWon).map(([name, info]) => `
                            <div class="sim-item-row">
                                <span>${info.count}x ${name}</span>
                                <span style="color: var(--accent-gold)">${formatZeny(info.totalValue)}z</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: var(--accent-red)">Erro: ${error.message}</p>`;
            }
        }

        // Carrega Runas Somatol√≥gicas
        async function loadSomatology() {
            try {
                const response = await fetch('/api/somatology');
                const data = await response.json();
                renderSomatology(data.somatology);
            } catch (error) {
                document.getElementById('somatologyContainer').innerHTML = 
                    `<p style="color: var(--accent-red)">Erro ao carregar: ${error.message}</p>`;
            }
        }

        function renderSomatology(somatology) {
            const container = document.getElementById('somatologyContainer');
            container.className = '';
            
            if (!somatology) {
                container.innerHTML = '<p>Dados n√£o dispon√≠veis</p>';
                return;
            }

            const profitClass = somatology.profit >= 0 ? 'stat-profit-positive' : 'stat-profit-negative';
            const verdictClass = somatology.isWorthIt ? 'verdict-worth' : 'verdict-not-worth';
            const verdictText = somatology.isWorthIt ? '‚úì VALE A PENA' : '‚úó N√ÉO VALE';

            container.innerHTML = `
                <div class="treasure-card" style="max-width: 800px; margin: 0 auto;">
                    <div class="treasure-header" style="background: linear-gradient(135deg, ${somatology.color}22, transparent)">
                        <span class="treasure-name" style="color: ${somatology.color}">${somatology.name}</span>
                        <span class="treasure-verdict ${verdictClass}">${verdictText}</span>
                    </div>
                    <div class="treasure-body">
                        <div class="stats-row">
                            <div class="stat-box">
                                <div class="stat-label">Custo (${somatology.totalAlmas.toLocaleString()} Almas)</div>
                                <div class="stat-value stat-cost">${formatZeny(somatology.totalCost)}z</div>
                                <small style="color: var(--text-secondary)">${formatZeny(somatology.costPerAlma)}z cada</small>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Valor Esperado</div>
                                <div class="stat-value stat-expected">${formatZeny(somatology.expectedValue)}z</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Lucro/Preju√≠zo</div>
                                <div class="stat-value ${profitClass}">
                                    ${somatology.profit >= 0 ? '+' : ''}${formatZeny(somatology.profit)}z
                                    <br><small>(${somatology.profitPercent >= 0 ? '+' : ''}${somatology.profitPercent.toFixed(1)}%)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: var(--bg-dark); border-radius: 8px;">
                            <div style="margin-bottom: 10px; color: var(--accent-gold);">
                                üìä M√©dia das Runas: <strong>${formatZeny(somatology.avgRunaPrice)}z</strong>
                                <span style="color: var(--text-secondary)">(${somatology.runasFound} runas encontradas)</span>
                            </div>
                        </div>

                        <div class="drops-list">
                            <button class="drops-toggle" onclick="toggleDrops(this)">
                                üìã Ver detalhes dos drops
                            </button>
                            <div class="drops-content">
                                ${somatology.drops.map(drop => `
                                    <div class="drop-item">
                                        <span class="drop-name">${drop.quantity}x ${drop.name}</span>
                                        <span class="drop-chance">${drop.chance}%</span>
                                        <span class="drop-value">${formatZeny(drop.itemPrice)}z</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="drops-list" style="margin-top: 15px;">
                            <button class="drops-toggle" onclick="toggleDrops(this)">
                                üß¨ Ver pre√ßos das Runas (${somatology.runasList.length})
                            </button>
                            <div class="drops-content">
                                ${somatology.runasList.slice(0, 15).map(runa => `
                                    <div class="drop-item">
                                        <span class="drop-name">${runa.name}</span>
                                        <span class="drop-chance">${runa.sellers} vendas</span>
                                        <span class="drop-value">${formatZeny(runa.price)}z</span>
                                    </div>
                                `).join('')}
                                ${somatology.runasList.length > 15 ? `
                                    <div style="text-align: center; color: var(--text-secondary); padding: 10px;">
                                        ... e mais ${somatology.runasList.length - 15} runas
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Carrega ao iniciar
        loadTreasures();
        loadSomatology();
    </script>
</body>
</html>

