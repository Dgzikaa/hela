// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =======================
// SISTEMA DE AUTENTICAÇÃO
// =======================

model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  nome      String
  senha     String   // Hash bcrypt
  role      String   @default("ADMIN") // "ADMIN", "GERENTE"
  discordId String?  // ID do Discord para enviar mensagens privadas
  ativo     Boolean  @default(true)
  
  // Cada usuário tem 1 jogador principal
  jogadorId Int?     @unique
  jogador   Jogador? @relation(fields: [jogadorId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  pedidosAprovados Pedido[] @relation("UsuarioAprovador")

  @@map("Usuario")
}

// =======================
// JOGADORES
// =======================

enum CategoriaJogador {
  HELA          // Time principal (fez Hela)
  CARRYS        // Só bosses 4, 5, 6
  SUPLENTE      // Pode fazer tudo
}

model Jogador {
  id         Int      @id @default(autoincrement())
  nick       String   @unique
  categorias String   // Array de categorias separadas por vírgula: "HELA,CARRYS"
  discord    String?  // Usuario do Discord (display name)
  discordId  String?  // ID do Discord para enviar mensagens
  ativo      Boolean  @default(true)
  
  // Sistema de rodízio
  essencial Boolean           @default(false) // Jogadores que NUNCA saem da PT
  ordemRodizio Int?           // Ordem no rodízio (para não-essenciais)
  ultimoCarry DateTime?       // Data do último carry que participou
  
  // Estatísticas
  totalCarrys Int             @default(0)
  totalGanho  Int             @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  usuario          Usuario?              // Usuário dono deste jogador
  missoesFora      Missao[]              @relation("JogadorFora") // Manter compatibilidade
  participacoes    ParticipacaoCarry[]

  @@map("jogadores")
}

// =======================
// BOSSES
// =======================

model Boss {
  id       Int    @id @default(autoincrement())
  nome     String
  mobId    Int    @unique // ID da API do Ragnatales
  ordem    Int    @unique // 1-6 para ordenação
  preco    Int    // Preço em KK (milhões de zeny)
  imagemUrl String // URL da imagem
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  itensPedido ItensPedido[]

  @@map("Boss")
}

// =======================
// CLIENTES (CRM COMPLETO)
// =======================

enum TierCliente {
  BRONZE   // 0-2 compras
  PRATA    // 3-5 compras
  OURO     // 6-10 compras
  PLATINA  // 11-20 compras
  DIAMANTE // 21+ compras
}

enum CategoriaCliente {
  POTENCIAL    // Nunca comprou, só perguntou
  AVENTUREIRO  // Pergunta muito, não fecha
  COMPRADOR    // 1-2 compras
  FIEL         // 3+ compras
  VIP          // Alto valor, tratamento especial
}

model Cliente {
  id              Int          @id @default(autoincrement())
  discordUserId   String       @unique
  discordUsername String
  
  // NOVOS: Dados pessoais para CRM
  nome            String?      // Nome real
  email           String?      // Email para contato
  telefone        String?      // WhatsApp
  nickIngame      String?      // Nick no RagnaTales
  
  // Classificação CRM
  categoria       CategoriaCliente @default(POTENCIAL)
  
  // Estatísticas
  totalCompras    Int          @default(0)
  totalGasto      Int          @default(0)
  tier            TierCliente  @default(BRONZE)
  
  // Métricas de engajamento
  totalContatos   Int          @default(0)  // Quantas vezes entrou em contato
  ultimoContato   DateTime?
  
  // Datas importantes
  primeiraCompra  DateTime?
  ultimaCompra    DateTime?
  
  // Preferências
  bossPreferido   String?      // Boss que mais compra
  diaPreferido    String?      // Dia da semana preferido
  
  // Marketing
  aceitaOfertas   Boolean      @default(true)
  ultimaOferta    DateTime?
  
  // Anotações dos admins
  observacoes     String?      @db.Text
  
  // Origem do cliente
  origem          String?      // "DISCORD", "INDICACAO", "SITE", etc
  indicadoPor     String?      // Quem indicou (para sistema de afiliados)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relações
  pedidos         Pedido[]
  leads           Lead[]
  inscricoesCarryGratis InscricaoCarryGratis[]

  @@map("Cliente")
}

// =======================
// CARRY GRÁTIS SEMANAL
// =======================

enum StatusInscricao {
  INSCRITO      // Aguardando sorteio
  SORTEADO      // Foi sorteado
  CONFIRMADO    // Confirmou presença
  NAO_PODE      // Disse que não pode
  SUBSTITUIDO   // Foi substituído por outro
  PARTICIPOU    // Participou do carry
  FALTOU        // Não apareceu
}

model InscricaoCarryGratis {
  id          Int      @id @default(autoincrement())
  
  // Participante
  discordId   String
  discordName String
  nickIngame  String
  
  // Cliente vinculado (se existir)
  clienteId   Int?
  cliente     Cliente? @relation(fields: [clienteId], references: [id])
  
  // Semana do sorteio (segunda-feira da semana)
  semana      DateTime
  
  // Status
  status      StatusInscricao @default(INSCRITO)
  
  // Posição no sorteio (1-4 = titulares, 5+ = reservas)
  posicaoSorteio Int?
  
  // Motivo caso não possa
  motivoAusencia String?
  
  // Data da confirmação/recusa
  dataResposta   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([discordId, semana]) // 1 inscrição por semana por pessoa
  @@map("inscricoes_carry_gratis")
}

// Configuração do Carry Grátis
model ConfiguracaoCarryGratis {
  id                    Int      @id @default(autoincrement())
  
  // Dia e hora do sorteio
  diaSorteio            Int      @default(0) // 0 = domingo, 1 = segunda, etc
  horaSorteio           String   @default("20:00")
  
  // Dia e hora do carry
  diaCarry              Int      @default(6) // 6 = sábado
  horaCarry             String   @default("21:00")
  
  // Quantidade de vagas
  vagasTitulares        Int      @default(4)
  vagasReservas         Int      @default(2)
  
  // Bosses inclusos (1-6)
  bossesInclusos        String   @default("1,2,3,4,5,6")
  
  // Horas para confirmar presença
  horasParaConfirmar    Int      @default(24)
  
  // Mensagem personalizada
  mensagemSorteio       String?  @db.Text
  
  // Ativo
  ativo                 Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("configuracao_carry_gratis")
}

// =======================
// CONFIRMAÇÃO DE PRESENÇA (CARRYS PAGOS)
// =======================

enum StatusConfirmacao {
  PENDENTE     // Aguardando resposta
  CONFIRMADO   // Confirmou presença
  NAO_PODE     // Não poderá participar
  SUBSTITUIDO  // Foi substituído
}

model ConfirmacaoPresenca {
  id              Int      @id @default(autoincrement())
  
  // Pedido relacionado
  pedidoId        Int
  
  // Jogador (pode ser cadastrado ou não)
  jogadorId       Int?
  jogadorNome     String   // Nome do jogador (backup)
  discordId       String?  // Para enviar mensagem
  
  // Status
  status          StatusConfirmacao @default(PENDENTE)
  
  // Motivo caso não possa
  motivo          String?
  
  // Datas
  dataEnvio       DateTime @default(now())
  dataResposta    DateTime?
  
  // Substituído por
  substituidoPor  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("confirmacoes_presenca")
}

// =======================
// CALCULADORA DE FARM
// =======================

model ConteudoFarm {
  id              Int      @id @default(autoincrement())
  
  nome            String   @unique // "Bio 5", "Verus", etc
  descricao       String?
  icone           String?  // URL do ícone
  
  // Limites
  fadigaMaxima    Int?     // Quantidade máxima de mobs
  limiteDiario    Int?     // Quantas vezes pode fazer por dia
  
  // Custos de entrada
  custoEntrada    Int      @default(0) // Zeny
  itemEntrada     String?  // Nome do item necessário
  itemEntradaQtd  Int?     // Quantidade do item
  
  // Tempo estimado
  tempoMinutos    Int      @default(60)
  
  // Ativo
  ativo           Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relações
  consumiveis     ConsumiveisFarm[]
  drops           DropsFarm[]
  
  @@map("conteudos_farm")
}

model ConsumiveisFarm {
  id              Int      @id @default(autoincrement())
  
  conteudoId      Int
  conteudo        ConteudoFarm @relation(fields: [conteudoId], references: [id], onDelete: Cascade)
  
  nome            String   // "Blue Potion", "Yggdrasil Berry", etc
  quantidade      Int      // Quantidade usada por run
  precoUnitario   Int      // Preço no mercado
  
  createdAt       DateTime @default(now())
  
  @@map("consumiveis_farm")
}

model DropsFarm {
  id              Int      @id @default(autoincrement())
  
  conteudoId      Int
  conteudo        ConteudoFarm @relation(fields: [conteudoId], references: [id], onDelete: Cascade)
  
  nome            String   // Nome do item
  itemId          Int?     // ID do item na API (para buscar preço)
  
  // Drop rate
  dropRate        Float    // Taxa em % (ex: 0.5 = 0.5%)
  quantidadeMedia Int      @default(1) // Média por run
  
  // Preço (pode ser fixo ou buscar da API)
  precoFixo       Int?     // Se tiver preço fixo
  
  createdAt       DateTime @default(now())
  
  @@map("drops_farm")
}

// =======================
// LEADS DO DISCORD
// =======================

enum StatusLead {
  INICIADO          // Começou conversa
  EM_NEGOCIACAO     // Discutindo detalhes
  AGUARDANDO_CONFIRMACAO // Esperando confirmar
  CONVERTIDO        // Virou pedido
  PERDIDO           // Não finalizou
}

model Lead {
  id              Int        @id @default(autoincrement())
  
  // Cliente
  clienteId       Int?
  cliente         Cliente?   @relation(fields: [clienteId], references: [id])
  
  discordUserId   String     // ID do usuário no Discord (backup)
  discordUsername String     // Username no Discord (backup)
  status          StatusLead @default(INICIADO)
  
  // Histórico da conversa (JSON)
  conversaHistorico String?  @db.Text
  
  // Pedido gerado (se converteu)
  pedidoId        Int?       @unique
  pedido          Pedido?    @relation(fields: [pedidoId], references: [id])
  
  ultimaInteracao DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@map("Lead")
}

// =======================
// PEDIDOS DE CARRY
// =======================

enum StatusPedido {
  PENDENTE      // Aguardando aprovação
  APROVADO      // Aprovado, aguardando agendamento
  AGENDADO      // Data definida
  EM_ANDAMENTO  // Carry em progresso
  CONCLUIDO     // Finalizado
  CANCELADO     // Cancelado
}

model Pedido {
  id            Int          @id @default(autoincrement())
  
  // Cliente
  clienteId     Int?
  cliente       Cliente?     @relation(fields: [clienteId], references: [id])
  
  nomeCliente   String
  contatoCliente String      // Discord, WhatsApp, etc
  
  // Origem
  origem        String       @default("WEB") // "WEB", "DISCORD"
  
  // Detalhes
  status        StatusPedido @default(PENDENTE)
  dataAgendada  DateTime?
  
  // Valores
  valorTotal    Int          @default(0)
  valorFinal    Int          @default(0)
  desconto      Int          @default(0)
  descontoTipo  String?      // "FIDELIDADE", "PROMOCAO", "PRIMEIRA_COMPRA"
  
  // Opções extras
  conquistaSemMorrer Boolean  @default(false)
  pacoteCompleto     Boolean  @default(false) // 1-6
  
  observacoes              String?
  jogadoresNaoCadastrados  String? // Nomes separados por vírgula para jogadores não cadastrados
  
  // Sistema de Reserva (pagamento antecipado)
  reservaPaga    Boolean   @default(false)
  valorReserva   Int       @default(0)
  dataReserva    DateTime?
  
  // Aprovação
  aprovadoPor      Int?
  dataAprovacao    DateTime?
  aprovador        Usuario?     @relation("UsuarioAprovador", fields: [aprovadoPor], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  itens         ItensPedido[]
  lead          Lead?        // Lead que originou (se veio do Discord)
  participacoes ParticipacaoCarry[] // Jogadores participantes

  @@map("Pedido")
}

// Itens do pedido (quais bosses o cliente quer)
model ItensPedido {
  id       Int   @id @default(autoincrement())
  pedidoId Int
  bossId   Int
  
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  boss     Boss   @relation(fields: [bossId], references: [id])
  
  preco    Int    // Preço no momento da compra
  
  createdAt DateTime @default(now())

  @@map("ItensPedido")
}

// Participação dos jogadores no carry
model ParticipacaoCarry {
  id         Int   @id @default(autoincrement())
  pedidoId   Int
  jogadorId  Int
  
  pedido     Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  jogador    Jogador @relation(fields: [jogadorId], references: [id])
  
  // Valor recebido por esse jogador
  valorRecebido Int @default(0)
  pago          Boolean @default(false) // Se o jogador já foi pago
  
  createdAt DateTime @default(now())

  @@map("participacoes_carry")
}

// =======================
// MIGRAÇÃO - MANTER COMPATIBILIDADE
// =======================

// Suplentes (DEPRECATED - migrar para Jogador)
model Suplente {
  id        Int      @id @default(autoincrement())
  nick      String   @unique
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  missoes   Missao[] @relation("SuplenteNaMissao")

  @@map("suplentes")
}

// Missões antigas (DEPRECATED - migrar para Pedido)
model Missao {
  id            Int       @id @default(autoincrement())
  data          DateTime
  tipo          String
  jogadorForaId Int
  jogadorFora   Jogador   @relation("JogadorFora", fields: [jogadorForaId], references: [id])
  suplenteId    Int?
  suplente      Suplente? @relation("SuplenteNaMissao", fields: [suplenteId], references: [id])
  carryNome     String?
  carryValor    Float?    @default(0)
  status        String
  observacoes   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("missoes")
}

// =======================
// SISTEMA DE SEGURANÇA
// =======================

// Logs de Auditoria
model LogAuditoria {
  id            Int      @id @default(autoincrement())
  
  // Usuário que realizou a ação
  usuarioId     Int?
  usuarioNome   String   // Backup caso usuário seja deletado
  
  // Ação realizada
  acao          String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc
  entidade      String   // Cliente, Pedido, Jogador, Usuario, etc
  entidadeId    Int?     // ID da entidade afetada
  
  // Detalhes
  descricao     String   // Descrição legível da ação
  dadosAntigos  String?  @db.Text // JSON com dados antes da mudança
  dadosNovos    String?  @db.Text // JSON com dados após a mudança
  
  // Metadados
  ip            String?
  userAgent     String?  @db.Text
  
  createdAt     DateTime @default(now())
  
  @@index([usuarioId])
  @@index([acao])
  @@index([entidade])
  @@index([createdAt])
  @@map("logs_auditoria")
}

// Permissões por usuário
model Permissao {
  id          Int      @id @default(autoincrement())
  usuarioId   Int
  
  // Módulos
  verDashboard       Boolean @default(true)
  gerenciarCarrys    Boolean @default(true)
  gerenciarClientes  Boolean @default(true)
  gerenciarJogadores Boolean @default(false)
  gerenciarUsuarios  Boolean @default(false)
  verRelatorios      Boolean @default(true)
  exportarDados      Boolean @default(false)
  configurarSistema  Boolean @default(false)
  verLogs            Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([usuarioId])
  @@map("permissoes")
}

// Sessões ativas (para controle de 2FA e sessões simultâneas)
model Sessao {
  id          String   @id @default(cuid())
  usuarioId   Int
  
  token       String   @unique
  ip          String?
  userAgent   String?  @db.Text
  
  ativo       Boolean  @default(true)
  ultimaAtividade DateTime @default(now())
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  
  @@index([usuarioId])
  @@index([token])
  @@map("sessoes")
}

// Configurações de Backup
model ConfigBackup {
  id                Int      @id @default(autoincrement())
  
  ativo             Boolean  @default(true)
  frequencia        String   @default("DIARIO") // DIARIO, SEMANAL, MENSAL
  hora              String   @default("03:00")  // HH:MM
  
  // Retenção
  manterUltimos     Int      @default(7)        // Manter últimos N backups
  
  // Destino
  destino           String   @default("LOCAL")  // LOCAL, S3, DRIVE
  caminhoLocal      String?
  
  // Último backup
  ultimoBackup      DateTime?
  proximoBackup     DateTime?
  statusUltimo      String?  // SUCCESS, ERROR
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("config_backup")
}