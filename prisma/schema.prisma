// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =======================
// SISTEMA DE AUTENTICAÇÃO
// =======================

model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  nome      String
  senha     String   // Hash bcrypt
  role      String   @default("ADMIN") // "ADMIN", "GERENTE"
  discordId String?  // ID do Discord para enviar mensagens privadas
  ativo     Boolean  @default(true)
  
  // Cada usuário tem 1 jogador principal
  jogadorId Int?     @unique
  jogador   Jogador? @relation(fields: [jogadorId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  pedidosAprovados Pedido[] @relation("UsuarioAprovador")

  @@map("Usuario")
}

// =======================
// JOGADORES
// =======================

enum CategoriaJogador {
  HELA          // Time principal (fez Hela)
  CARRYS        // Só bosses 4, 5, 6
  SUPLENTE      // Pode fazer tudo
}

model Jogador {
  id         Int      @id @default(autoincrement())
  nick       String   @unique
  categorias String   // Array de categorias separadas por vírgula: "HELA,CARRYS"
  discord    String?  // Usuario do Discord (display name)
  discordId  String?  // ID do Discord para enviar mensagens
  ativo      Boolean  @default(true)
  
  // Sistema de rodízio
  essencial Boolean           @default(false) // Jogadores que NUNCA saem da PT
  ordemRodizio Int?           // Ordem no rodízio (para não-essenciais)
  ultimoCarry DateTime?       // Data do último carry que participou
  
  // Estatísticas
  totalCarrys Int             @default(0)
  totalGanho  Int             @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  usuario          Usuario?              // Usuário dono deste jogador
  missoesFora      Missao[]              @relation("JogadorFora") // Manter compatibilidade
  participacoes    ParticipacaoCarry[]

  @@map("jogadores")
}

// =======================
// BOSSES
// =======================

model Boss {
  id       Int    @id @default(autoincrement())
  nome     String
  mobId    Int    @unique // ID da API do Ragnatales
  ordem    Int    @unique // 1-6 para ordenação
  preco    Int    // Preço em KK (milhões de zeny)
  imagemUrl String // URL da imagem
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  itensPedido ItensPedido[]

  @@map("Boss")
}

// =======================
// CLIENTES (DISCORD)
// =======================

enum TierCliente {
  BRONZE   // 0-2 compras
  PRATA    // 3-5 compras
  OURO     // 6-10 compras
  PLATINA  // 11-20 compras
  DIAMANTE // 21+ compras
}

model Cliente {
  id              Int          @id @default(autoincrement())
  discordUserId   String       @unique
  discordUsername String
  
  // Estatísticas
  totalCompras    Int          @default(0)
  totalGasto      Int          @default(0)
  tier            TierCliente  @default(BRONZE)
  
  // Datas importantes
  primeiraCompra  DateTime?
  ultimaCompra    DateTime?
  
  // Preferências
  bossPreferido   String?      // Boss que mais compra
  diaPreferido    String?      // Dia da semana preferido
  
  // Marketing
  aceitaOfertas   Boolean      @default(true)
  ultimaOferta    DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relações
  pedidos         Pedido[]
  leads           Lead[]

  @@map("Cliente")
}

// =======================
// LEADS DO DISCORD
// =======================

enum StatusLead {
  INICIADO          // Começou conversa
  EM_NEGOCIACAO     // Discutindo detalhes
  AGUARDANDO_CONFIRMACAO // Esperando confirmar
  CONVERTIDO        // Virou pedido
  PERDIDO           // Não finalizou
}

model Lead {
  id              Int        @id @default(autoincrement())
  
  // Cliente
  clienteId       Int?
  cliente         Cliente?   @relation(fields: [clienteId], references: [id])
  
  discordUserId   String     // ID do usuário no Discord (backup)
  discordUsername String     // Username no Discord (backup)
  status          StatusLead @default(INICIADO)
  
  // Histórico da conversa (JSON)
  conversaHistorico String?  @db.Text
  
  // Pedido gerado (se converteu)
  pedidoId        Int?       @unique
  pedido          Pedido?    @relation(fields: [pedidoId], references: [id])
  
  ultimaInteracao DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@map("Lead")
}

// =======================
// PEDIDOS DE CARRY
// =======================

enum StatusPedido {
  PENDENTE      // Aguardando aprovação
  APROVADO      // Aprovado, aguardando agendamento
  AGENDADO      // Data definida
  EM_ANDAMENTO  // Carry em progresso
  CONCLUIDO     // Finalizado
  CANCELADO     // Cancelado
}

model Pedido {
  id            Int          @id @default(autoincrement())
  
  // Cliente
  clienteId     Int?
  cliente       Cliente?     @relation(fields: [clienteId], references: [id])
  
  nomeCliente   String
  contatoCliente String      // Discord, WhatsApp, etc
  
  // Origem
  origem        String       @default("WEB") // "WEB", "DISCORD"
  
  // Detalhes
  status        StatusPedido @default(PENDENTE)
  dataAgendada  DateTime?
  
  // Valores
  valorTotal    Int          @default(0)
  valorFinal    Int          @default(0)
  desconto      Int          @default(0)
  descontoTipo  String?      // "FIDELIDADE", "PROMOCAO", "PRIMEIRA_COMPRA"
  
  // Opções extras
  conquistaSemMorrer Boolean  @default(false)
  pacoteCompleto     Boolean  @default(false) // 1-6
  
  observacoes              String?
  jogadoresNaoCadastrados  String? // Nomes separados por vírgula para jogadores não cadastrados
  
  // Aprovação
  aprovadoPor      Int?
  dataAprovacao    DateTime?
  aprovador        Usuario?     @relation("UsuarioAprovador", fields: [aprovadoPor], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  itens         ItensPedido[]
  lead          Lead?        // Lead que originou (se veio do Discord)
  participacoes ParticipacaoCarry[] // Jogadores participantes

  @@map("Pedido")
}

// Itens do pedido (quais bosses o cliente quer)
model ItensPedido {
  id       Int   @id @default(autoincrement())
  pedidoId Int
  bossId   Int
  
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  boss     Boss   @relation(fields: [bossId], references: [id])
  
  preco    Int    // Preço no momento da compra
  
  createdAt DateTime @default(now())

  @@map("ItensPedido")
}

// Participação dos jogadores no carry
model ParticipacaoCarry {
  id         Int   @id @default(autoincrement())
  pedidoId   Int
  jogadorId  Int
  
  pedido     Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  jogador    Jogador @relation(fields: [jogadorId], references: [id])
  
  // Valor recebido por esse jogador
  valorRecebido Int @default(0)
  
  createdAt DateTime @default(now())

  @@map("participacoes_carry")
}

// =======================
// MIGRAÇÃO - MANTER COMPATIBILIDADE
// =======================

// Suplentes (DEPRECATED - migrar para Jogador)
model Suplente {
  id        Int      @id @default(autoincrement())
  nick      String   @unique
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  missoes   Missao[] @relation("SuplenteNaMissao")

  @@map("suplentes")
}

// Missões antigas (DEPRECATED - migrar para Pedido)
model Missao {
  id            Int       @id @default(autoincrement())
  data          DateTime
  tipo          String
  jogadorForaId Int
  jogadorFora   Jogador   @relation("JogadorFora", fields: [jogadorForaId], references: [id])
  suplenteId    Int?
  suplente      Suplente? @relation("SuplenteNaMissao", fields: [suplenteId], references: [id])
  carryNome     String?
  carryValor    Float?    @default(0)
  status        String
  observacoes   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("missoes")
}
