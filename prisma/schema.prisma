// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =======================
// SISTEMA DE AUTENTICAÇÃO
// =======================

model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  nome      String
  senha     String   // Hash bcrypt
  role      String   @default("ADMIN") // "ADMIN", "GERENTE"
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  pedidosAprovados Pedido[] @relation("UsuarioAprovador")

  @@map("usuarios")
}

// =======================
// JOGADORES
// =======================

enum CategoriaJogador {
  HELA          // Time principal (fez Hela)
  CARRYS        // Só bosses 4, 5, 6
  SUPLENTE      // Pode fazer tudo
}

model Jogador {
  id        Int               @id @default(autoincrement())
  nick      String            @unique
  categoria CategoriaJogador
  discord   String?           // Usuario do Discord
  ativo     Boolean           @default(true)
  
  // Estatísticas
  totalCarrys Int             @default(0)
  totalGanho  Float           @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  participacoes ParticipacaoCarry[]
  missoesFora   Missao[]              @relation("JogadorFora") // Manter compatibilidade

  @@map("jogadores")
}

// =======================
// BOSSES
// =======================

model Boss {
  id       Int    @id @default(autoincrement())
  nome     String @unique
  mobId    Int    @unique // ID da API do Ragnatales
  ordem    Int    // 1-6 para ordenação
  preco    Float  // Preço em KK (milhões de zeny)
  imagemUrl String // URL da imagem
  ativo    Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  itensPedido ItensPedido[]

  @@map("bosses")
}

// =======================
// PEDIDOS DE CARRY
// =======================

enum StatusPedido {
  PENDENTE      // Aguardando aprovação
  APROVADO      // Aprovado, aguardando agendamento
  AGENDADO      // Data definida
  EM_ANDAMENTO  // Carry em progresso
  CONCLUIDO     // Finalizado
  CANCELADO     // Cancelado
}

model Pedido {
  id            Int          @id @default(autoincrement())
  
  // Cliente
  nomeCliente   String
  contatoCliente String      // Discord, WhatsApp, etc
  
  // Detalhes
  status        StatusPedido @default(PENDENTE)
  dataAgendada  DateTime?
  dataRealizada DateTime?
  
  // Valores
  valorTotal    Float        @default(0)
  valorPago     Float        @default(0)
  desconto      Float        @default(0)
  
  // Opções extras
  conquistaSemMorrer Boolean  @default(false)
  pacoteCompleto     Boolean  @default(false) // 1-6
  
  observacoes   String?
  
  // Aprovação
  aprovadoPor   Int?
  aprovador     Usuario?     @relation("UsuarioAprovador", fields: [aprovadoPor], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  itens         ItensPedido[]
  participacoes ParticipacaoCarry[]

  @@map("pedidos")
}

// Itens do pedido (quais bosses o cliente quer)
model ItensPedido {
  id       Int   @id @default(autoincrement())
  pedidoId Int
  bossId   Int
  
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  boss     Boss   @relation(fields: [bossId], references: [id])
  
  preco    Float  // Preço no momento da compra
  
  createdAt DateTime @default(now())

  @@map("itens_pedido")
}

// Participação dos jogadores no carry
model ParticipacaoCarry {
  id         Int   @id @default(autoincrement())
  pedidoId   Int
  jogadorId  Int
  
  pedido     Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  jogador    Jogador @relation(fields: [jogadorId], references: [id])
  
  // Valor recebido por esse jogador
  valorRecebido Float @default(0)
  
  createdAt DateTime @default(now())

  @@map("participacoes_carry")
}

// =======================
// MIGRAÇÃO - MANTER COMPATIBILIDADE
// =======================

// Suplentes (DEPRECATED - migrar para Jogador)
model Suplente {
  id        Int      @id @default(autoincrement())
  nick      String   @unique
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  missoes   Missao[] @relation("SuplenteNaMissao")

  @@map("suplentes")
}

// Missões antigas (DEPRECATED - migrar para Pedido)
model Missao {
  id            Int       @id @default(autoincrement())
  data          DateTime
  tipo          String
  jogadorForaId Int
  jogadorFora   Jogador   @relation("JogadorFora", fields: [jogadorForaId], references: [id])
  suplenteId    Int?
  suplente      Suplente? @relation("SuplenteNaMissao", fields: [suplenteId], references: [id])
  carryNome     String?
  carryValor    Float?    @default(0)
  status        String
  observacoes   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("missoes")
}
